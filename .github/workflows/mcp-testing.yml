name: MCP Shrimp Task Manager Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  test-mcp-server:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build server
      run: npm run build
      
    - name: Setup Python for MCP Testing Framework
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install MCP Testing Framework
      run: |
        pip install mcp-testing-framework
        
    - name: Run MCP Server Tests
      run: |
        # Start server in background
        timeout 60s node dist/index.js &
        SERVER_PID=$!
        sleep 5
        
        # Run comprehensive test suite
        mcp-test --test-mcp-servers --config test-config.json --output-format json > test-results.json
        
        # Stop server
        kill $SERVER_PID || true
        
    - name: Run Security Tests
      run: |
        # Start server in background
        timeout 60s node dist/index.js &
        SERVER_PID=$!
        sleep 5
        
        # Run security test suite
        mcp-test --run-test-suite security --config test-config.json --output-format json > security-results.json
        
        # Stop server
        kill $SERVER_PID || true
        
    - name: Run Performance Tests
      run: |
        # Start server in background
        timeout 120s node dist/index.js &
        SERVER_PID=$!
        sleep 5
        
        # Run performance test suite
        mcp-test --run-test-suite performance --config test-config.json --output-format json > performance-results.json
        
        # Stop server
        kill $SERVER_PID || true
        
    - name: Generate Test Report
      if: always()
      run: |
        # Generate comprehensive HTML report
        mcp-test --generate-test-report --config test-config.json --output-format html
        
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-node-${{ matrix.node-version }}
        path: |
          test-results.json
          security-results.json
          performance-results.json
          test-report.html
          
    - name: Upload Test Coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-node-${{ matrix.node-version }}
        path: coverage/

  integration-tests:
    runs-on: ubuntu-latest
    needs: test-mcp-server
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build server
      run: npm run build
      
    - name: Setup Python for MCP Testing Framework
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install MCP Testing Framework
      run: |
        pip install mcp-testing-framework
        
    - name: Run Integration Tests
      run: |
        # Start server in background
        timeout 180s node dist/index.js &
        SERVER_PID=$!
        sleep 10
        
        # Run integration test suite
        mcp-test --run-test-suite integration --config test-config.json --output-format json > integration-results.json
        
        # Stop server
        kill $SERVER_PID || true
        
    - name: Upload Integration Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results
        path: integration-results.json
