# 虾米任务管理器系统架构

[English](../en/architecture.md) | [中文](../zh/architecture.md)

本文档描述虾米任务管理器的系统架构设计，包括各组件的功能、交互方式和数据流。

## 1. 系统整体架构

虾米任务管理器采用模块化设计，基于 MCP (Model Context Protocol) 协议实现与 LLM 的互动。系统由以下核心组件构成：

```
                    +------------------+
                    |                  |
                    |   MCP 客户端     |
                    | (如 Cursor IDE)  |
                    |                  |
                    +---------+--------+
                              |
                              | MCP 协议
                              |
                    +---------v--------+
                    |                  |
                    |   工具注册层     |  <-- 新增 delete_task 工具
                    |   (index.ts)     |      新增 clear_all_tasks 工具
                    |                  |      新增 update_task 工具
                    |                  |      新增 update_task_files 工具
                    +---------+--------+
                              |
                              |
          +------------------+------------------+
          |                  |                  |
+---------v--------+ +-------v---------+
|                  | |                 |
|    工具实现层    | |   模型逻辑层    |
|  (taskTools.ts)  | | (taskModel.ts)  |
|                  | |                 |
+------------------+ +-------+---------+
                              |
                              |
                    +---------v--------+
                    |                  |
                    |   数据存储层     |
                    |   (JSON 文件)    |
                    |                  |
                    +------------------+
```

## 2. 主要组件说明

### 2.1 工具注册层 (index.ts)

工具注册层负责将各功能工具注册到 MCP 系统中，使其能够被 LLM 访问和使用。

**主要功能**：

- 注册 `plan_task` 工具函数，用于任务规划
- 注册 `analyze_task` 工具函数，用于任务分析
- 注册 `reflect_task` 工具函数，用于批判性审查分析结果
- 注册 `split_tasks` 工具函数，用于将复杂任务分解为子任务
- 注册 `list_tasks` 工具函数，用于生成任务清单
- 注册 `execute_task` 工具函数，用于执行特定任务
- 注册 `verify_task` 工具函数，用于验证任务完成度
- 注册 `complete_task` 工具函数，用于标记任务为完成状态
- 注册 `delete_task` 工具函数，用于删除未完成的任务
- 注册 `clear_all_tasks` 工具函数，用于清除所有未完成的任务
- 注册 `update_task` 工具函数，用于更新任务内容
- 注册 `update_task_files` 工具函数，用于更新任务相关文件列表

### 2.2 工具实现层 (tools/\*.ts)

工具实现层包含具体工具函数的实现，处理参数解析、验证和结果格式化。

**核心文件**：

- `taskTools.ts`: 任务管理相关工具
- `fileLoader.ts`: 任务相关文件的摘要生成工具

**主要功能**：

- 实现 `planTask` 工具函数，初始化并详细规划任务流程
- 实现 `analyzeTask` 工具函数，深入分析任务需求
- 实现 `reflectTask` 工具函数，批判性审查分析结果
- 实现 `splitTasks` 工具函数，将复杂任务分解为独立且可追踪的子任务
- 实现 `listTasks` 工具函数，生成结构化任务清单
- 实现 `executeTask` 工具函数，按照预定义计划执行特定任务
- 实现 `verifyTask` 工具函数，全面验证任务完成度
- 实现 `completeTask` 工具函数，正式标记任务为完成状态
- 实现 `deleteTask` 工具函数，删除未完成的任务
- 实现 `clearAllTasks` 工具函数，删除所有未完成的任务
- 实现 `updateTask` 工具函数，更新任务内容
- 实现 `updateTaskRelatedFiles` 工具函数，更新任务相关文件列表

### 2.3 模型逻辑层 (models/\*.ts)

模型逻辑层包含核心业务逻辑和数据处理函数，负责实现各种功能的逻辑处理。

**核心文件**：

- `taskModel.ts`: 任务数据模型和操作

**主要功能**：

- 在 `taskModel.ts` 中实现创建、读取、更新和删除任务的功能
- 在 `taskModel.ts` 中实现 `deleteTask` 函数，删除未完成的任务
- 在 `taskModel.ts` 中实现 `clearAllTasks` 函数，删除所有未完成的任务
- 在 `taskModel.ts` 中实现 `updateTask` 函数，更新任务内容
- 在 `taskModel.ts` 中实现 `updateTaskRelatedFiles` 函数，更新任务相关文件列表
- 在 `taskModel.ts` 中实现 `assessTaskComplexity` 函数，评估任务复杂度
- 在 `taskModel.ts` 中实现 `loadTaskById` 函数，载入特定任务
- 在 `taskModel.ts` 中实现 `completeTask` 函数，标记任务为完成状态

### 2.4 数据模型定义 (types/index.ts)

定义系统中使用的所有数据类型和接口。

**主要类型**：

- `TaskStatus` 枚举：定义任务状态，包括待处理、进行中、已完成和被阻挡
- `TaskDependency` 接口：定义任务依赖关系
- `RelatedFileType` 枚举：定义文件关联类型，如待修改、参考资料、待建立、依赖文件和其他
- `RelatedFile` 接口：定义任务相关文件结构
- `Task` 接口：定义任务的完整数据结构
- `TaskComplexityLevel` 枚举：定义任务复杂度级别，如低复杂度、中等复杂度、高复杂度和极高复杂度
- `TaskComplexityThresholds` 常量：定义复杂度评估阈值
- `TaskComplexityAssessment` 接口：记录复杂度评估结果

### 2.5 工具函数 (utils/\*.ts)

提供各种辅助功能的工具函数。

**核心文件**：

- `summaryExtractor.ts`: 实现摘要提取和生成功能
- `fileLoader.ts`: 实现任务相关文件的摘要生成功能

**主要功能**：

- 实现 `extractSummary` 函数，从文本中提取简短摘要
- 实现 `generateTaskSummary` 函数，基于任务名称和描述生成任务完成摘要
- 实现 `extractTitle` 函数，从内容中提取适合作为标题的文本
- 实现 `loadTaskRelatedFiles` 函数，生成任务相关文件的内容摘要
- 实现 `generateFileInfo` 函数，生成文件基本资讯摘要

### 2.6 数据存储层

使用 JSON 文件作为数据存储，保存任务信息。

**核心文件**：

- `data/tasks.json`: 存储所有任务数据
- `data/backups/`: 存储任务数据备份

## 3. 数据流

### 3.1 任务删除流程

```
LLM 调用 delete_task
      |
      v
识别任务是否存在
      |
      v
检查任务状态(拒绝删除已完成任务)
      |
      v
检查依赖关系(拒绝删除有依赖的任务)
      |
      v
执行删除操作
      |
      v
返回结果给 LLM
```

### 3.2 任务复杂度评估流程

```
LLM 调用 execute_task
      |
      v
载入任务信息
      |
      v
评估任务复杂度
      |
      +------------> 计算描述长度
      |                   |
      +------------> 计算依赖数量
      |                   |
      +------------> 计算注记长度
      |                   |
      +------------> 检查是否有注记
      |                   |
      v                   v
确定复杂度级别 <----- 应用评估阈值
      |
      v
生成处理建议
      |
      v
更新任务提示，包含复杂度信息
      |
      v
返回增强后的任务执行提示给 LLM
```

### 3.3 任务完成流程

```
LLM 调用 complete_task
      |
      v
载入任务信息
      |
      v
检查是否提供摘要
      |
      +---- 有 ----> 使用提供的摘要
      |
      +---- 无 ----> 自动生成摘要
                      |
                      +---> 基于任务名称和描述
                      |
                      +---> 提取关键信息
                      |
                      +---> 格式化摘要文本
      |
      v
更新任务状态为已完成
      |
      v
保存摘要到任务记录
      |
      v
返回结果给 LLM
```

### 3.4 清除所有任务流程

```
LLM 调用 clear_all_tasks
      |
      v
检查确认参数（必须为 true）
      |
      v
创建数据备份
      |
      v
载入当前任务列表
      |
      |
      v
筛选出未完成的任务
      |
      v
执行批量删除
      |
      v
更新数据文件
      |
      v
返回清除结果给 LLM
```

### 3.5 更新任务内容流程

```
LLM 调用 update_task
      |
      v
载入任务信息
      |
      v
检查任务是否存在
      |
      v
检查任务状态（阻止更新已完成任务）
      |
      v
验证更新参数（至少提供一个更新字段）
      |
      v
执行更新操作
      |
      v
返回更新结果给 LLM
```

### 3.6 更新任务相关文件流程

```
LLM 调用 update_task_files
      |
      v
载入任务信息
      |
      v
检查任务是否存在
      |
      v
检查任务状态（阻止更新已完成任务）
      |
      v
验证文件列表格式
      |
      v
处理每个相关文件
      |      |
      |      +---> 验证文件路径
      |      |
      |      +---> 检查行号范围（如有提供）
      |      |
      |      +---> 验证文件类型
      |
      v
更新任务的相关文件列表
      |
      v
返回更新结果给 LLM
```

### 3.7 文件处理流程

```
处理任务相关文件
      |
      v
根据文件类型进行优先级排序
      |      |
      |      +---> 待修改 > 参考资料 > 依赖文件 > 待建立 > 其他
      |
      v
生成文件摘要
      |      |
      |      +---> 对于指定行号范围的文件，生成该范围的摘要
      |      |
      |      +---> 对于一般文件，生成整体内容摘要
      |
      v
返回文件摘要结果
```

## 4. 系统交互图

### 4.1 LLM 与任务管理器交互

```
+-------+    1.调用工具     +----------------+
|       |------------------>|                |
|  LLM  |                   | 虾米任务管理器  |
|       |<------------------|                |
+-------+    4.返回结果     +-------+--------+
                                    |
                            +-------v--------+
                            |                |
                            |  JSON 数据存储 |
                            |                |
                            +----------------+
```

### 4.2 工具层与模型层交互

```
+-------------+     调用     +-------------+     读写    +------------+
|             |------------->|             |------------>|            |
| 工具实现层   |             | 模型逻辑层   |            | 数据存储层  |
|             |<-------------|             |<------------|            |
+-------------+    返回结果   +-------------+    返回数据 +------------+
```

## 5. 核心功能架构图

### 5.1 任务规划功能

```
+----------------+     +----------------+     +------------------+
|                |     |                |     |                  |
| planTaskSchema |---->| planTask      |---->| 任务规划响应生成  |
|                |     | (taskTools.ts) |     |                  |
+----------------+     +-------+--------+     +------------------+
```

### 5.2 任务分析功能

```
+----------------+     +----------------+     +------------------+
|                |     |                |     |                  |
| analyzeTaskSchema|---->| analyzeTask    |---->| 技术分析指引生成 |
|                |     | (taskTools.ts) |     |                  |
+----------------+     +-------+--------+     +------------------+
```

### 5.3 任务反思功能

```
+----------------+     +----------------+     +------------------+
|                |     |                |     |                  |
| reflectTaskSchema|---->| reflectTask    |---->| 反思提示与建议生成|
|                |     | (taskTools.ts) |     |                  |
+----------------+     +-------+--------+     +------------------+
```

### 5.4 任务拆分功能

```
+----------------+     +----------------+     +------------------+
|                |     |                |     |                  |
| splitTasksSchema|---->| splitTasks    |---->| createTasks      |
|                |     | (taskTools.ts) |     | (taskModel.ts)   |
+----------------+     +-------+--------+     +------------------+
```

### 5.5 任务执行功能

```
+----------------+     +----------------+     +------------------+
|                |     |                |     |                  |
| executeTaskSchema|---->| executeTask    |---->| assessTaskComplexity|
|                |     | (taskTools.ts) |     | (taskModel.ts)   |
+----------------+     +-------+--------+     +------------------+
                               |
                               v
                        +------+---------------------+------+
                        |    任务执行指南和上下文生成      |
                        +------+---------------------+------+
```

### 5.6 任务验证功能

```
+----------------+     +----------------+     +------------------+
|                |     |                |     |                  |
| verifyTaskSchema|---->| verifyTask    |---->| 任务验证评估     |
|                |     | (taskTools.ts) |     |                  |
+----------------+     +-------+--------+     +------------------+
```

### 5.7 完成任务功能

```
+----------------+     +----------------+     +------------------+
|                |     |                |     |                  |
| completeTaskSchema|---->| completeTask   |---->| updateTaskSummary|
|                |     | (taskTools.ts) |     | (taskModel.ts)   |
+----------------+     +-------+--------+     +------------------+
                               |
                               v
                        +------+--------+
                        | summaryExtractor|
                        | (utils)       |
                        +---------------+
```

### 5.8 任务删除功能

```
+----------------+     +----------------+     +------------------+
|                |     |                |     |                  |
| deleteTaskSchema|---->| deleteTask    |---->| modelDeleteTask  |
|                |     | (taskTools.ts) |     | (taskModel.ts)   |
+----------------+     +-------+--------+     +------------------+
                               |
                               v
                        +------+---------------------+------+
                        |     检查任务状态和依赖关系      |
                        +------+---------------------+------+
```

### 5.9 清除所有任务功能

```
+------------------+     +----------------+     +------------------+
|                  |     |                |     |                  |
| clearAllTasksSchema|---->| clearAllTasks  |---->| modelClearAllTasks|
|                  |     | (taskTools.ts) |     | (taskModel.ts)   |
+------------------+     +-------+--------+     +------------------+
                                 |
                                 v
                          +------+---------------------+------+
                          |     确认参数检查和数据备份      |
                          +------+---------------------+------+
                                 |
                                 v
                          +------+---------------------+------+
                          |     筛选和批量删除未完成任务    |
                          +------+---------------------+------+
```

### 5.10 更新任务功能

```
+------------------+     +----------------+     +------------------+
|                  |     |                |     |                  |
| updateTaskSchema |---->| updateTask    |---->| updateTask       |
|                  |     | (taskTools.ts) |     | (taskModel.ts)   |
+------------------+     +-------+--------+     +------------------+
                                 |
                                 v
                          +------+---------------------+------+
                          |  检查任务状态和更新参数有效性    |
                          +------+---------------------+------+
```

### 5.11 更新任务相关文件功能

```
+----------------------+     +---------------------+     +----------------------+
|                      |     |                     |     |                      |
| updateTaskFilesSchema |---->| updateTaskRelatedFiles |---->| updateTaskRelatedFiles |
|                      |     | (taskTools.ts)      |     | (taskModel.ts)       |
+----------------------+     +-----------+---------+     +-----------+----------+
                                       |                           |
                                       v                           v
                               +-------+-------------------------+------+
                               |     验证文件格式和路径有效性        |
                               +-------+-------------------------+------+
                                       |
                                       v
                               +-------+-------------------------+------+
                               |     更新任务相关文件列表            |
                               +-------+-------------------------+------+
```

## 6. 扩展性考虑

### 6.1 新功能扩展方式

虾米任务管理器的模块化设计使其易于扩展。要添加新功能，通常需要：

1. 在 `types/index.ts` 中定义相关数据类型
2. 在相应的模型文件中实现核心逻辑
3. 在工具层创建对应的工具函数
4. 在 `index.ts` 中注册新工具

### 6.2 目前的扩展点

系统当前提供以下扩展点：

- **任务处理流程扩展**：可通过修改 `executeTask`、`verifyTask` 等函数扩展任务处理流程
- **复杂度评估扩展**：可在 `assessTaskComplexity` 中添加更多评估指标
- **摘要生成扩展**：可增强 `summaryExtractor.ts` 中的算法
- **文件处理扩展**：可在 `fileLoader.ts` 中支持更多文件类型的摘要格式化
- **过滤条件扩展**：可在任务查询中添加更多过滤条件选项

## 7. 系统限制与未来改进

### 7.1 当前限制

- 使用文件存储，不适合多用户并发场景
- 缺乏用户认证和权限控制
- 摘要生成使用简单规则，可进一步改进
- 文件处理不读取实际文件内容，仅生成摘要信息

### 7.2 未来可能的改进

- 迁移到数据库存储，提高并发处理能力
- 添加用户管理和访问控制
- 使用更先进的算法优化摘要生成
- 添加任务优先级和时间规划功能
- 实现任务执行进度追踪
- 增强文件关联系统，支持更复杂的关系类型
- 实现自动识别相关文件的能力
- 支持实际读取文件内容，提供更详细的上下文

## 8. 结论

虾米任务管理器采用模块化、分层设计，使系统具有良好的可维护性和扩展性。通过 12 个核心工具函数和完善的数据模型，系统能够有效地管理复杂项目的任务流程，特别在需要长期上下文记忆的场景中表现出色。

系统的设计重点在于提供清晰的任务管理流程，同时增强 LLM 在执行任务时的上下文记忆能力，通过精确的文件关联和智能上下文载入，有效解决了 LLM 在处理长期复杂任务时的记忆限制问题。

随着系统的进一步发展，未来将着重改进数据存储方式、优化摘要生成算法、增强文件处理能力和添加更多任务管理功能，使系统能够应对更多复杂的任务管理场景。
