[English](../en/functionality-checklist.md) | [中文](../zh/functionality-checklist.md)

# 虾米任务管理器 - 功能实现清单

本文档列出虾米任务管理器系统中所有实际实现的工具函数、参数结构和功能。此清单作为文档审查的基准参考。

## 类型定义与枚举

### 任务状态枚举 (TaskStatus)

- `PENDING = "待处理"` - 已创建但尚未开始执行的任务
- `IN_PROGRESS = "进行中"` - 当前正在执行的任务
- `COMPLETED = "已完成"` - 已成功完成并通过验证的任务
- `BLOCKED = "被阻挡"` - 由于依赖关系而暂时无法执行的任务

### 任务依赖关系 (TaskDependency)

- `taskId: string` - 前置任务的唯一标识符，当前任务执行前必须完成此依赖任务

### 相关文件类型枚举 (RelatedFileType)

- `TO_MODIFY = "待修改"` - 需要在任务中修改的文件
- `REFERENCE = "参考资料"` - 任务的参考资料或相关文档
- `CREATE = "待建立"` - 需要在任务中建立的文件
- `DEPENDENCY = "依赖文件"` - 任务依赖的组件或库文件
- `OTHER = "其他"` - 其他类型的相关文件

### 相关文件 (RelatedFile)

- `path: string` - 文件路径，可以是相对于项目根目录的路径或绝对路径
- `type: RelatedFileType` - 文件与任务的关系类型
- `description?: string` - 文件的补充描述，说明其与任务的具体关系或用途
- `lineStart?: number` - 相关代码区块的起始行（选填）
- `lineEnd?: number` - 相关代码区块的结束行（选填）

### 任务介面 (Task)

- `id: string` - 任务的唯一标识符
- `name: string` - 简洁明确的任务名称
- `description: string` - 详细的任务描述，包含实施要点和验收标准
- `notes?: string` - 补充说明、特殊处理要求或实施建议（选填）
- `status: TaskStatus` - 任务当前的执行状态
- `dependencies: TaskDependency[]` - 任务的前置依赖关系列表
- `createdAt: Date` - 任务创建的时间戳
- `updatedAt: Date` - 任务最后更新的时间戳
- `completedAt?: Date` - 任务完成的时间戳（仅适用于已完成的任务）
- `summary?: string` - 任务完成摘要，简洁描述实施结果和重要决策（仅适用于已完成的任务）
- `relatedFiles?: RelatedFile[]` - 与任务相关的文件列表（选填）

### 任务复杂度级别枚举 (TaskComplexityLevel)

- `LOW = "低复杂度"` - 简单且直接的任务，通常不需要特殊处理
- `MEDIUM = "中等复杂度"` - 具有一定复杂性但仍可管理的任务
- `HIGH = "高复杂度"` - 复杂且耗时的任务，需要特别关注
- `VERY_HIGH = "极高复杂度"` - 极其复杂的任务，建议拆分处理

### 任务复杂度评估结果 (TaskComplexityAssessment)

- `level: TaskComplexityLevel` - 整体复杂度级别
- `metrics: object` - 各项评估指标的详细数据
  - `descriptionLength: number` - 描述长度
  - `dependenciesCount: number` - 依赖数量
  - `notesLength: number` - 注记长度
  - `hasNotes: boolean` - 是否有注记
- `recommendations: string[]` - 处理建议列表

## 工具函数与参数

### 1. plan_task

**描述**：初始化并详细规划任务流程，建立明确的目标与成功标准

**参数**：

- `description: string` (必填) - 完整详细的任务问题描述，应包含任务目标、背景及预期成果
  - 必须至少 10 个字符
- `requirements?: string` (选填) - 任务的特定技术要求、业务约束条件或品质标准

**返回值**：

- 返回一个包含规划提示的响应，用于引导用户开始任务分析

### 2. analyze_task

**描述**：深入分析任务需求并系统性检查代码库，评估技术可行性与潜在风险

**参数**：

- `summary: string` (必填) - 结构化的任务摘要，包含任务目标、范围与关键技术挑战
  - 必须至少 20 个字符
- `initialConcept: string` (必填) - 初步解答构想，包含技术方案、架构设计和实施策略
  - 必须至少 50 个字符
- `previousAnalysis?: string` (选填) - 前次迭代的分析结果，用于持续改进方案

**返回值**：

- 返回一个包含技术分析指引的响应，用于指导用户进行深入分析

### 3. reflect_task

**描述**：批判性审查分析结果，评估方案完整性并识别优化机会，确保解决方案符合最佳实践

**参数**：

- `summary: string` (必填) - 结构化的任务摘要，保持与分析阶段一致以确保连续性
  - 必须至少 20 个字符
- `analysis: string` (必填) - 完整详尽的技术分析结果，包括所有技术细节、依赖组件和实施方案
  - 必须至少 100 个字符

**返回值**：

- 返回一个包含反思提示与实施建议的响应

### 4. split_tasks

**描述**：将复杂任务分解为独立且可追踪的子任务，建立明确的依赖关系和优先顺序

**参数**：

- `updateMode: "append" | "overwrite" | "selective" | "clearAllTasks"` (必填) - 任务更新模式选择：
  - `append`：保留所有现有任务并添加新任务
  - `overwrite`：清除所有未完成任务并完全替换
  - `selective`：根据任务名称匹配更新现有任务，保留不在列表中的任务
  - `clearAllTasks`：清除所有任务并创建备份
- `tasks: Array<object>` (必填) - 结构化的任务清单，每个任务应保持原子性且有明确的完成标准
  - `name: string` (必填) - 简洁明确的任务名称，应能清晰表达任务目的
    - 不超过 100 个字符
  - `description: string` (必填) - 详细的任务描述，包含实施要点、技术细节和验收标准
    - 必须至少 10 个字符
  - `notes?: string` (选填) - 补充说明、特殊处理要求或实施建议
  - `dependencies?: string[]` (选填) - 此任务依赖的前置任务 ID 或任务名称列表
  - `relatedFiles?: RelatedFile[]` (选填) - 与任务相关的文件列表

**返回值**：

- 返回一个包含任务拆分结果的响应，包括成功创建的任务数量和任务 ID 列表

### 5. list_tasks

**描述**：生成结构化任务清单，包含完整状态追踪、优先级和依赖关系

**参数**：无

**返回值**：

- 返回一个包含任务清单的响应，按状态分组显示所有任务

### 6. execute_task

**描述**：按照预定义计划执行特定任务，确保每个步骤的输出符合质量标准

**参数**：

- `taskId: string` (必填) - 待执行任务的唯一标识符，必须是系统中存在的有效任务 ID

**返回值**：

- 返回一个包含任务执行指南的响应，包括任务详情、复杂度评估和执行步骤建议

### 7. verify_task

**描述**：全面验证任务完成度，确保所有需求与技术标准都已满足，并无遗漏细节

**参数**：

- `taskId: string` (必填) - 待验证任务的唯一标识符，必须是系统中存在的有效任务 ID

**返回值**：

- 返回一个包含任务验证结果的响应，包括完成标准检查和具体验证项

### 8. complete_task

**描述**：正式标记任务为完成状态，生成详细的完成报告，并更新关联任务的依赖状态

**参数**：

- `taskId: string` (必填) - 待完成任务的唯一标识符，必须是系统中存在的有效任务 ID
- `summary?: string` (选填) - 任务完成摘要，简洁描述实施结果和重要决策

**返回值**：

- 返回一个包含任务完成确认的响应，包括完成时间和更新的依赖任务状态

### 9. delete_task

**描述**：删除未完成的任务，但不允许删除已完成的任务，确保系统记录的完整性

**参数**：

- `taskId: string` (必填) - 待删除任务的唯一标识符，必须是系统中存在且未完成的任务 ID

**返回值**：

- 返回一个包含任务删除结果的响应，包括成功或失败的讯息

### 10. clear_all_tasks

**描述**：删除系统中所有未完成的任务，该指令必须由用户明确确认才能执行。同时将任务备份到 memory 子目录，保存任务历史记录以供未来参考。

**参数**：

- `confirm: boolean` (必填) - 确认删除所有未完成的任务（此操作不可逆）

**返回值**：

- 返回一个包含清除操作结果的响应，包括成功或失败的讯息、备份文件名和备份位置

**重要细节**：

- 在删除任务前，会自动将当前任务列表备份到 data/memory 子目录
- 备份文件使用时间戳命名，格式为 tasks_memory_YYYY-MM-DDThh-mm-ss.json
- memory 子目录作为长期记忆库，用于存储任务历史记录，供未来任务规划参考

### 11. query_task

**描述**：根据关键字或 ID 搜寻任务，显示省略版的任务资讯

**参数**：

- `query: string` (必填) - 搜寻查询文字，可以是任务 ID 或多个关键字（空格分隔）
  - 必须至少 1 个字符
- `isId: boolean` (选填) - 指定是否为 ID 查询模式，默认为否（关键字模式）
- `page: number` (选填) - 分页页码，默认为第 1 页
- `pageSize: number` (选填) - 每页显示的任务数量，默认为 5 笔，最大 20 笔
  - 必须为正整数，范围 1-20

**返回值**：

- 返回一个包含搜寻结果的响应，包括符合条件的任务列表、分页资讯和总结果数量

**重要细节**：

- 当 `isId` 为 true 时，系统会精确查询指定 ID 的任务
- 当 `isId` 为 false 时，系统会在任务名称、描述和摘要中搜寻指定关键字
- 关键字模式支持多个关键字（以空格分隔），将返回符合任一关键字的任务
- 结果会按任务状态和更新时间排序，便于快速找到最相关的任务

### 12. update_task

**描述**：更新任务内容，包括名称、描述和注记，但不允许修改已完成的任务

**参数**：

- `taskId: string` (必填) - 待更新任务的唯一标识符，必须是系统中存在且未完成的任务 ID
- `name?: string` (选填) - 任务的新名称
- `description?: string` (选填) - 任务的新描述内容
- `notes?: string` (选填) - 任务的新补充说明

**返回值**：

- 返回一个包含任务更新结果的响应，包括成功或失败的讯息

### 13. get_task_detail

**描述**：根据任务 ID 获取任务的完整详细信息，包括未截断的实现指南和验证标准等

**参数**：

- `taskId: string` (必填) - 欲检视详情的任务 ID
  - 必须至少 1 个字符

**返回值**：

- 返回一个包含任务完整详情的响应，包括所有任务属性，特别是完整的实现指南和验证标准

**重要细节**：

- 与 `list_tasks` 不同，此功能返回单个任务的完整详情，没有内容截断
- 适用于深入了解特定任务的要求和技术细节
- 提供完整的相关文件列表和任务分析结果
- 可用于检视执行过程中可能被省略的长文本内容

### 14. update_task_files

**描述**：更新任务相关文件列表，用于记录与任务相关的代码文件、参考资料等

**参数**：

- `taskId: string` (必填) - 待更新任务的唯一标识符，必须是系统中存在且未完成的任务 ID
- `relatedFiles: Array<RelatedFile>` (必填) - 与任务相关的文件列表
  - `path: string` (必填) - 文件路径，可以是相对于项目根目录的路径或绝对路径
  - `type: RelatedFileType` (必填) - 文件与任务的关系类型
  - `description?: string` (选填) - 文件的补充描述
  - `lineStart?: number` (选填) - 相关代码区块的起始行
  - `lineEnd?: number` (选填) - 相关代码区块的结束行

**返回值**：

- 返回一个包含文件更新结果的响应，包括成功或失败的讯息

## 工具函数重要细节

### 依赖关系 (dependencies) 处理

- 在 `splitTasks` 和其他函数中，`dependencies` 参数允许接受任务名称或任务 ID(UUID)
- 系统会在任务创建或更新时将字串阵列转换为 `TaskDependency` 物件阵列
- 任务依赖关系形成有向无环图(DAG)，用于确定任务执行顺序和阻塞状态

### 任务复杂度评估

- 系统使用 `assessTaskComplexity` 函数评估任务的复杂度
- 评估基于多个指标：描述长度、依赖数量、注记长度等
- 根据 `TaskComplexityThresholds` 定义的阈值来判定复杂度级别
- 复杂度评估结果用于生成适当的处理建议

### 文件处理功能

- `loadTaskRelatedFiles` 函数不实际读取档案内容，仅生成文件资讯摘要
- 文件按类型优先级排序：待修改 > 参考资料 > 依赖文件 > 待建立 > 其他
- 支持指定代码区块行号范围，便于精确定位关键实现

## 实用工具函数

### 摘要提取 (summaryExtractor.ts)

- `extractSummary` - 从文本中提取简短摘要，自动处理 Markdown 格式
- `generateTaskSummary` - 基于任务名称和描述生成任务完成摘要
- `extractTitle` - 从内容中提取适合作为标题的文本

### 文件加载 (fileLoader.ts)

- `loadTaskRelatedFiles` - 生成任务相关文件的内容摘要
- `generateFileInfo` - 生成文件基本资讯摘要

## 任务记忆功能

任务记忆功能是虾米任务管理器的重要特性，它使系统具备长期记忆能力，能够保存、查询和利用过去的任务执行经验。

### 核心实现

1. **自动备份机制**：

   - 在 `clearAllTasks` 函数中实现双重备份功能
   - 将任务备份同时保存在 data 目录和 data/memory 子目录
   - 使用时间戳命名备份文件，格式为 tasks_memory_YYYY-MM-DDThh-mm-ss.json

2. **智能提示指导**：
   - 在 `planTask` 函数的提示词中添加任务记忆检索指南
   - 指导 Agent 如何查找、分析和应用历史任务记录
   - 提供智能参考建议，促进知识重用

### 使用场景

- **任务规划时**：参考类似任务的实施方案和最佳实践
- **问题解决时**：查阅过去遇到的类似问题及其解决方法
- **代码重用时**：识别过去实现的可重用组件或模式
- **经验学习时**：分析过去成功和失败案例，持续优化工作方式

### 技术要点

- 使用相对路径引用 memory 目录，保持代码的一致性和可维护性
- 确保 memory 目录存在，如不存在则自动创建
- 保持原有的错误处理模式，确保系统稳定性
- 备份过程透明无感，不影响用户正常操作流程

此功能无需额外工具或配置，系统会自动在任务清除时保存历史记录，并在任务规划时提供智能指导，使 Agent 能够充分利用过去的经验和知识。
